apiVersion: apps/v1
kind: Deployment
metadata:
  name: perfect-charge
  namespace: perfect-charge
spec:
  selector:
    matchLabels:
      app: perfect-charge
  template:
    metadata:
      labels:
        app: perfect-charge
    spec:
      volumes:
        - name: shared-data
          emptyDir: {}
      imagePullSecrets:
        - name: regcred
      containers:
        - name: value
          image: ghcr.io/rhjensen79/perfect-charge/value:sha-eaf0e66b2093127167171fd29c6457553704669a
          imagePullPolicy: Always
          resources:
            requests:
              memory: 256Mi
              cpu: 0.1m
          env:
            - name: BARRY_METER_ID
              valueFrom:
                secretKeyRef:
                  name: barry
                  key: barry_meter_id
            - name: BARRY_TOKEN
              valueFrom:
                secretKeyRef:
                  name: barry
                  key: barry_token
          livenessProbe:
            exec:
              command:
                - python
                - liveness_probe.py
            initialDelaySeconds: 60
            periodSeconds: 300
          volumeMounts:
            - name: shared-data
              mountPath: /usr/src/app/data
        - name: control
          image: ghcr.io/rhjensen79/perfect-charge/control:sha-3570faa102febac12d562a4196b254a3bc9adc46
          imagePullPolicy: Always
          resources:
            requests:
              memory: 256Mi
              cpu: 0.1m
          env:
            - name: EASEE_USER
              valueFrom:
                secretKeyRef:
                  name: easee
                  key: easee_user
            - name: EASEE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: easee
                  key: easee_password
          volumeMounts:
            - name: shared-data
              mountPath: /usr/src/app/data
        - name: log
          image: ghcr.io/rhjensen79/perfect-charge/log:sha-f54216331dd3e6c14846f6b74ced506274d76657
          imagePullPolicy: Always
          resources:
            requests:
              memory: 256Mi
              cpu: 0.1m
          volumeMounts:
            - name: shared-data
              mountPath: /data
        - name: monitoring
          image: ghcr.io/rhjensen79/perfect-charge/monitoring:sha-97e3daff2f988a7b8226cf1ad6f52c3fd9440b54
          imagePullPolicy: Always
          resources:
            requests:
              memory: 256Mi
              cpu: 0.1m
          volumeMounts:
            - name: shared-data
              mountPath: /usr/src/app/data
---
apiVersion: v1
kind: Service
metadata:
  name: perfect-charge-monitoring-service
  namespace: perfect-charge
spec:
  selector:
    app: monitoring
  ports:
  - port: 80
    targetPort: 80
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: monitoring-perfect-charge
  namespace: perfect-charge
spec:
  secretName: tls-cert-pc-robert-jensen
  privateKey:
    rotationPolicy: Always
  dnsNames:
  - pc.robert-jensen.dk
  issuerRef:
    name: letsencrypt
    kind: ClusterIssuer
    group: cert-manager.io
---
apiVersion: projectcontour.io/v1
kind: HTTPProxy
metadata:
  name: perfect-charge-https
  namespace: perfect-charge
spec:
  virtualhost:
    fqdn: pc.robert-jensen.dk
    tls:
      #passthrough: true
      secretName: tls-cert-pc-robert-jensen
  routes:
    - conditions:
      - prefix: /
      services:
        - name: perfect-charge-monitoring-service
          port: 80